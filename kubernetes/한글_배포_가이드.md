# 🎯 LionPay 쿠버네티스 배포 - 한글 요약

초보자도 따라할 수 있도록 정리한 한글 요약 가이드입니다.

## 📌 이 문서는 언제 읽나요?

- ✅ 쿠버네티스가 처음이신가요?
- ✅ 배포 과정을 빠르게 이해하고 싶으신가요?
- ✅ 단계별로 정확히 따라하고 싶으신가요?

## 🏗️ 전체 배포 구조 (쉽게 설명)

### 1단계: 사용자 → CloudFront
```
사용자가 https://api.lionpay.shop을 방문
         ↓
  CloudFront (HTTPS 보안 처리)
         ↓
  ALB (Load Balancer - 트래픽 분배)
```

### 2단계: ALB → 쿠버네티스 클러스터
```
ALB (Amazon Load Balancer)
         ↓
  쿠버네티스 Ingress (라우팅 규칙)
         ↓
  Auth 서비스  또는  Wallet 서비스
```

### 3단계: 서비스 → Pod (실제 실행되는 컨테이너)
```
Auth 서비스
    ├─ Auth Pod 1 (복제본 1)
    └─ Auth Pod 2 (복제본 2)

Wallet 서비스
    ├─ Wallet Pod 1 (복제본 1)
    └─ Wallet Pod 2 (복제본 2)
```

---

## 📁 생성된 파일 구조

```
kubernetes/                          <- 이 폴더가 생성됨
├── 00_START_HERE.md                 <- 먼저 읽기!
├── README.md                        <- 전체 개요
├── QUICKSTART.md                    <- 5분 배포 가이드
├── DEPLOYMENT_GUIDE.md              <- 상세 배포 가이드
├── CORS_GUIDE.md                    <- 백엔드 설정 가이드
│
├── base/                            <- 공통 설정 (모든 환경이 공유)
│   ├── namespace.yaml               <- 폴더 만드는 파일
│   ├── configmap.yaml               <- 환경변수 설정
│   ├── auth-service.yaml            <- Auth 서비스 (8080 포트)
│   ├── auth-deployment.yaml         <- Auth 실행 설정
│   ├── wallet-service.yaml          <- Wallet 서비스 (8081 포트)
│   ├── wallet-deployment.yaml       <- Wallet 실행 설정
│   ├── ingress.yaml                 <- 라우팅 규칙 (ALB)
│   ├── hpa.yaml                     <- 자동 확장 설정
│   ├── pdb.yaml                     <- 고가용성 보장
│   └── kustomization.yaml           <- 모든 파일 통합
│
└── overlays/                        <- 환경별 설정
    ├── dev/                         <- 개발 환경
    │   └── kustomization.yaml       <- Dev 커스터마이징
    └── prod/                        <- 프로덕션 환경
        └── kustomization.yaml       <- Prod 커스터마이징
```

---

## 🚀 빠른 배포 (5분)

### 1️⃣ 준비 (1분)

```bash
# AWS 계정 ID 복사 (나중에 사용)
aws sts get-caller-identity --query Account --output text

# 예: 123456789012
```

### 2️⃣ 파일 수정 (2분)

```bash
# 모든 YAML 파일에서 YOUR_AWS_ACCOUNT_ID를 위의 ID로 변경
# Windows PowerShell에서:

$accountId = "YOUR_AWS_ACCOUNT_ID_HERE"  # <- 위에서 복사한 ID 붙여넣기

Get-ChildItem -Path "kubernetes" -Recurse -Include "*.yaml" | 
  ForEach-Object {
    (Get-Content $_.FullName) -replace 'YOUR_AWS_ACCOUNT_ID', $accountId | 
    Set-Content $_.FullName
  }
```

### 3️⃣ 배포 (2분)

```bash
# 네임스페이스 생성 (폴더 만들기)
kubectl apply -f kubernetes/base/namespace.yaml

# 모든 설정 배포
kubectl apply -k kubernetes/overlays/dev

# 배포 상태 확인
kubectl get pods -n lionpay
```

**완료!** ✅

---

## 📊 각 파일이 하는 일

### 1. namespace.yaml
**역할**: "lionpay" 폴더 만들기
- 모든 LionPay 리소스를 한 폴더에 정리
- 다른 프로젝트와 섞이지 않게 격리

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: lionpay  # <- 폴더 이름
```

### 2. configmap.yaml
**역할**: 환경변수 저장소
- 프론트엔드 도메인 목록 (CORS)
- API 주소 저장

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: lionpay-config
data:
  ALLOWED_ORIGINS: "https://lionpay.shop,https://admin.lionpay.shop"
  API_BASE_URL: "https://api.lionpay.shop"
```

### 3. auth-service.yaml & wallet-service.yaml
**역할**: 서비스 만들기 (내부 이름 등록)
- Auth 서비스 → `auth-service.lionpay.svc.cluster.local:8080`
- Wallet 서비스 → `wallet-service.lionpay.svc.cluster.local:8081`

클러스터 내부에서는 이 이름으로 접근 가능:
```bash
curl http://auth-service:8080/api/v1/auth/health
```

### 4. auth-deployment.yaml & wallet-deployment.yaml
**역할**: Pod 실행 및 관리
- ECR 이미지로 Pod 생성
- 2개 복제본 실행 (고가용성)
- 자동 재시작 설정

```yaml
spec:
  replicas: 2  # 2개의 Pod 동시 실행
  image: "YOUR_AWS_ACCOUNT_ID.dkr.ecr.ap-northeast-2.amazonaws.com/lionpay-auth:latest"
```

### 5. ingress.yaml
**역할**: 라우팅 규칙 설정 (ALB에 전달)
- `/api/v1/auth/*` 요청 → auth-service로 보내기
- `/api/v1/wallet/*` 요청 → wallet-service로 보내기

```yaml
- path: /api/v1/auth
  backend:
    service:
      name: auth-service
      port:
        number: 8080
```

### 6. hpa.yaml
**역할**: 자동 확장 설정
- 트래픽 많으면 → Pod 더 많이 실행
- 트래픽 적으면 → Pod 개수 줄이기

```yaml
minReplicas: 2   # 최소 2개
maxReplicas: 10  # 최대 10개
```

### 7. pdb.yaml
**역할**: 고가용성 보장
- 노드 업데이트 중에도 최소 1개 Pod은 항상 실행
- 서비스 중단 방지

### 8. kustomization.yaml
**역할**: 모든 파일 통합 관리
- base 버전: 공통 설정
- dev 버전: 개발용 커스터마이징
- prod 버전: 프로덕션용 커스터마이징

---

## 🔄 배포 흐름도

```
사용자 요청
    ↓
https://api.lionpay.shop
    ↓
CloudFront (HTTPS 암호화)
    ↓
ALB (트래픽 분배)
    ↓
Kubernetes Ingress (라우팅)
    ↓
        /api/v1/auth      →  auth-service
        /api/v1/wallet    →  wallet-service
    ↓
Auth Pod 또는 Wallet Pod (실제 실행)
    ↓
데이터베이스 / 외부 API 호출
```

---

## ✅ 배포 후 확인하기

### 1. Pod이 실행 중인지 확인
```bash
kubectl get pods -n lionpay
# 결과:
# NAME                                  READY   STATUS    RESTARTS   AGE
# auth-deployment-abc123-xyz789         1/1     Running   0          5m
# auth-deployment-abc123-xyz790         1/1     Running   0          5m
# wallet-deployment-abc456-xyz791       1/1     Running   0          5m
# wallet-deployment-abc456-xyz792       1/1     Running   0          5m
```

### 2. 서비스가 제대로 등록되었는지 확인
```bash
kubectl get svc -n lionpay
# 결과:
# NAME              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)
# auth-service      ClusterIP   10.100.100.1     <none>        8080/TCP
# wallet-service    ClusterIP   10.100.100.2     <none>        8081/TCP
```

### 3. Ingress (ALB)가 생성되었는지 확인
```bash
kubectl get ingress -n lionpay
# 결과:
# NAME                CLASS   HOSTS           ADDRESS          PORTS
# lionpay-ingress     alb     api.lionpay     k8s-xxx-xxx.elb   80
```

### 4. 로그 확인하기
```bash
# Auth 서비스 로그
kubectl logs -n lionpay -l app=auth --tail=20

# Wallet 서비스 로그
kubectl logs -n lionpay -l app=wallet --tail=20
```

### 5. API 테스트
```bash
# 클러스터 내부에서 테스트
$albDns = kubectl get ingress -n lionpay -o jsonpath='{.items[0].status.loadBalancer.ingress[0].hostname}'

curl -H "Host: api.lionpay.shop" "http://$albDns/api/v1/auth/health"
curl -H "Host: api.lionpay.shop" "http://$albDns/api/v1/wallet/health"
```

---

## 🆘 일반적인 문제 해결

### 문제 1: Pod이 Pending 상태
```bash
# 상세 정보 확인
kubectl describe pod <POD_NAME> -n lionpay

# 보통 원인: 노드의 리소스 부족
# 해결: 더 큰 노드 추가 또는 리소스 제한 감소
```

### 문제 2: 이미지를 찾을 수 없음
```bash
# 확인: ECR에 이미지가 제대로 푸시되었나?
aws ecr describe-images --repository-name lionpay-auth --region ap-northeast-2

# 확인: YAML 파일의 이미지 경로가 맞나?
grep "image:" kubernetes/base/*.yaml
```

### 문제 3: CORS 오류
```bash
# 원인: 백엔드의 CORS 설정이 빠졌음
# 해결: kubernetes/CORS_GUIDE.md 읽고 백엔드 코드 수정

# Auth 서비스: SecurityConfig.java에 CORS 설정
# Wallet 서비스: Program.cs에 CORS 미들웨어 추가
```

---

## 🔑 꼭 기억해야 할 개념 5가지

### 1. Namespace (네임스페이스)
- 쿠버네티스의 "폴더" 개념
- 리소스들을 그룹화하고 격리
- 명령어에 항상 `-n lionpay` 추가

### 2. Service (서비스)
- 클러스터 내부 DNS 이름 제공
- Pod가 죽고 새로 생겨도 서비스 이름은 변하지 않음
- ClusterIP: 클러스터 내부만 접근 가능

### 3. Deployment (배포)
- Pod의 생성, 관리, 업데이트 담당
- replicas로 동시 실행 Pod 개수 지정
- 자동 재시작, 롤링 업데이트 제공

### 4. Ingress (진입점)
- 클러스터 외부에서 서비스에 접근하게 함
- ALB Ingress Controller: AWS ALB 자동 생성
- 라우팅 규칙 정의

### 5. ConfigMap (설정맵)
- 환경변수, 설정파일 저장
- Pod에 주입되어 사용 가능
- 보안이 필요한 데이터는 Secret 사용

---

## 📚 추가 학습 자료

### 한글 가이드
1. [kubernetes/CORS_GUIDE.md](./CORS_GUIDE.md) - CORS 설정 (백엔드)
2. [kubernetes/QUICKSTART.md](./QUICKSTART.md) - 5분 빠른 시작
3. [kubernetes/DEPLOYMENT_GUIDE.md](./DEPLOYMENT_GUIDE.md) - 상세 배포 (초보자 가능)

### 공식 문서 (영문)
- [Kubernetes 공식 튜토리얼](https://kubernetes.io/docs/tutorials/)
- [AWS EKS 사용자 가이드](https://docs.aws.amazon.com/eks/)

---

## 🎓 단계별 학습 경로

### 1단계: 기본 개념 이해 (30분)
- [x] Namespace, Service, Deployment 이해
- [x] base와 overlays 개념 이해

### 2단계: 배포 준비 (15분)
- [ ] AWS 계정 ID 확인
- [ ] ECR 이미지 확인
- [ ] YAML 파일 수정

### 3단계: 배포 실행 (10분)
- [ ] namespace 생성
- [ ] 리소스 배포
- [ ] 상태 확인

### 4단계: 검증 (15분)
- [ ] Pod 로그 확인
- [ ] API 엔드포인트 테스트
- [ ] CORS 설정 확인

### 5단계: CloudFront 설정 (별도)
- [ ] CloudFront Distribution 생성
- [ ] Route53 CNAME 설정

---

## 💡 팁과 트릭

### 명령어 단축키
```bash
# 네임스페이스 매번 지정하지 않기
kubectl config set-context --current --namespace=lionpay

# 이제 -n lionpay 생략 가능
kubectl get pods  # lionpay 네임스페이스에서만 조회
```

### 실시간 모니터링
```bash
# -w 옵션으로 실시간 변화 보기
kubectl get pods -n lionpay -w

# 종료: Ctrl+C
```

### 빠른 로그 보기
```bash
# 최근 50줄 실시간 보기
kubectl logs -n lionpay -l app=auth --tail=50 -f
```

---

## 🎯 다음 할일

✅ 완료한 일:
- [x] 쿠버네티스 매니페스트 파일 생성

⏳ 앞으로 할 일:
- [ ] 백엔드 CORS 설정 (CORS_GUIDE.md 참조)
- [ ] ECR 이미지 빌드 및 푸시
- [ ] YAML 파일에서 YOUR_AWS_ACCOUNT_ID 수정
- [ ] 배포 실행
- [ ] CloudFront 설정

---

**한글 가이드 작성 완료!** 🎉
더 자세한 내용은 각 영문 가이드를 참조하세요.

- 📌 빠른 시작: [QUICKSTART.md](./QUICKSTART.md)
- 📖 상세 가이드: [DEPLOYMENT_GUIDE.md](./DEPLOYMENT_GUIDE.md)
- 🔐 CORS 설정: [CORS_GUIDE.md](./CORS_GUIDE.md)
