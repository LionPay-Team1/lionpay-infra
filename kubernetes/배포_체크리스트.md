# ğŸ“‹ LionPay ì¿ ë²„ë„¤í‹°ìŠ¤ ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

## âœ… ìƒì„±ëœ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í™•ì¸ (11ê°œ íŒŒì¼)

### base ë””ë ‰í† ë¦¬ (10ê°œ íŒŒì¼)
- [x] namespace.yaml - ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±
- [x] configmap.yaml - í™˜ê²½ë³€ìˆ˜ ì„¤ì •
- [x] auth-service.yaml - Auth ì„œë¹„ìŠ¤
- [x] auth-deployment.yaml - Auth ë°°í¬ (2 replicas)
- [x] wallet-service.yaml - Wallet ì„œë¹„ìŠ¤
- [x] wallet-deployment.yaml - Wallet ë°°í¬ (2 replicas)
- [x] ingress.yaml - ALB Ingress (HTTP only)
- [x] hpa.yaml - ìë™ í™•ì¥ (2~10 replicas)
- [x] pdb.yaml - Pod Disruption Budget (ê³ ê°€ìš©ì„±)
- [x] kustomization.yaml - Kustomize í†µí•© ì„¤ì •

### overlays ë””ë ‰í† ë¦¬ (2ê°œ í™˜ê²½)
- [x] dev/kustomization.yaml - Dev í™˜ê²½ ì„¤ì •
- [x] prod/kustomization.yaml - Prod í™˜ê²½ ì„¤ì •

### ê°€ì´ë“œ ë¬¸ì„œ (5ê°œ)
- [x] 00_START_HERE.md - ì‹œì‘ ê°€ì´ë“œ
- [x] README.md - ì „ì²´ ê°œìš”
- [x] QUICKSTART.md - 5ë¶„ ë¹ ë¥¸ ì‹œì‘
- [x] DEPLOYMENT_GUIDE.md - ìƒì„¸ ë°°í¬ ê°€ì´ë“œ
- [x] CORS_GUIDE.md - CORS ì„¤ì • (ë°±ì—”ë“œ ì½”ë“œ í¬í•¨)
- [x] í•œê¸€_ë°°í¬_ê°€ì´ë“œ.md - í•œê¸€ ìš”ì•½

**ì´ ìƒì„±ëœ íŒŒì¼: 23ê°œ** âœ¨

---

## ğŸš€ ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

### Phase 1: ì¤€ë¹„ ë‹¨ê³„ (ì‚¬ì „ ìš”êµ¬ì‚¬í•­)
- [ ] AWS ê³„ì • ID í™•ì¸
  ```bash
  aws sts get-caller-identity --query Account --output text
  ```

- [ ] EKS í´ëŸ¬ìŠ¤í„° ì—°ê²° ê°€ëŠ¥
  ```bash
  aws eks update-kubeconfig --name lionpay-dev-eks --region ap-northeast-2
  kubectl cluster-info
  ```

- [ ] ALB Ingress Controller ì„¤ì¹˜ í™•ì¸
  ```bash
  kubectl get deployment -n kube-system -l app.kubernetes.io/name=aws-load-balancer-controller
  ```

- [ ] Metrics Server ì„¤ì¹˜ í™•ì¸ (HPAìš©)
  ```bash
  kubectl get deployment metrics-server -n kube-system
  ```

- [ ] ECR ë¦¬í¬ì§€í† ë¦¬ ìƒì„± í™•ì¸
  ```bash
  aws ecr describe-repositories --region ap-northeast-2
  ```

### Phase 2: ì½”ë“œ ì¤€ë¹„
- [ ] Auth ì„œë¹„ìŠ¤ CORS ì„¤ì • (Spring Boot)
  - íŒŒì¼: `lionpay-auth/src/main/java/.../SecurityConfig.java`
  - ì°¸ì¡°: `kubernetes/CORS_GUIDE.md`

- [ ] Wallet ì„œë¹„ìŠ¤ CORS ì„¤ì • (.NET)
  - íŒŒì¼: `lionpay-wallet/Program.cs`
  - ì°¸ì¡°: `kubernetes/CORS_GUIDE.md`

- [ ] í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„
  - Auth: `/api/v1/auth/health`
  - Wallet: `/api/v1/wallet/health`

### Phase 3: ì´ë¯¸ì§€ ì¤€ë¹„
- [ ] lionpay-auth ì´ë¯¸ì§€ ë¹Œë“œ
  ```bash
  cd lionpay-auth
  docker build -t lionpay-auth:latest .
  ```

- [ ] lionpay-wallet ì´ë¯¸ì§€ ë¹Œë“œ
  ```bash
  cd lionpay-wallet
  docker build -t lionpay-wallet:latest .
  ```

- [ ] ECRì— ì´ë¯¸ì§€ í‘¸ì‹œ
  ```bash
  aws ecr get-login-password --region ap-northeast-2 | \
    docker login --username AWS --password-stdin <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-2.amazonaws.com
  
  docker tag lionpay-auth:latest <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-2.amazonaws.com/lionpay-auth:latest
  docker push <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-2.amazonaws.com/lionpay-auth:latest
  ```

### Phase 4: ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìˆ˜ì •
- [ ] YAML íŒŒì¼ì˜ YOUR_AWS_ACCOUNT_ID ìˆ˜ì •
  ```powershell
  $accountId = aws sts get-caller-identity --query Account --output text
  Get-ChildItem -Path "kubernetes" -Recurse -Include "*.yaml" | 
    ForEach-Object {
      (Get-Content $_.FullName) -replace 'YOUR_AWS_ACCOUNT_ID', $accountId | 
      Set-Content $_.FullName
    }
  ```

- [ ] configmap.yamlì˜ CORS Origins í™•ì¸
  ```bash
  grep "ALLOWED_ORIGINS" kubernetes/base/configmap.yaml
  ```

- [ ] Ingress í˜¸ìŠ¤íŠ¸ ì„¤ì • í™•ì¸ (api.lionpay.shop)
  ```bash
  grep "host:" kubernetes/base/ingress.yaml
  ```

---

## ğŸ¯ ë°°í¬ ë‹¨ê³„ (ì‹¤í–‰)

### Step 1: Namespace ìƒì„±
```bash
kubectl apply -f kubernetes/base/namespace.yaml

# í™•ì¸
kubectl get namespace lionpay
```
- [ ] Namespace ìƒì„± ì™„ë£Œ

### Step 2: Dev í™˜ê²½ ë°°í¬
```bash
# ë¯¸ë¦¬ë³´ê¸° (ì„ íƒì‚¬í•­)
kubectl kustomize kubernetes/overlays/dev

# ë°°í¬ ì‹¤í–‰
kubectl apply -k kubernetes/overlays/dev
```
- [ ] ë°°í¬ ëª…ë ¹ ì‹¤í–‰ ì™„ë£Œ

### Step 3: ë°°í¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§
```bash
# ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ (Ctrl+Cë¡œ ì¢…ë£Œ)
kubectl get pods -n lionpay -w
```

ìƒíƒœ í™•ì¸ ì²´í¬ë¦¬ìŠ¤íŠ¸:
- [ ] auth-deployment Pod 2ê°œ ëª¨ë‘ Running
- [ ] wallet-deployment Pod 2ê°œ ëª¨ë‘ Running
- [ ] ëª¨ë“  Podì´ 1/1 Ready ìƒíƒœ

### Step 4: ë¦¬ì†ŒìŠ¤ ìƒíƒœ í™•ì¸
```bash
# ì „ì²´ ë¦¬ì†ŒìŠ¤ í™•ì¸
kubectl get all -n lionpay

# ì„œë¹„ìŠ¤ í™•ì¸
kubectl get svc -n lionpay

# Ingress í™•ì¸ (ALB ì£¼ì†Œ í™•ì¸)
kubectl get ingress -n lionpay -o wide

# HPA ìƒíƒœ í™•ì¸
kubectl get hpa -n lionpay

# PDB í™•ì¸
kubectl get poddisruptionbudget -n lionpay
```

- [ ] ì„œë¹„ìŠ¤ 2ê°œ(auth-service, wallet-service) ìƒì„±
- [ ] Ingress 1ê°œ ìƒì„±
- [ ] ALB DNS ì£¼ì†Œ í™•ì¸ë¨
- [ ] HPA 2ê°œ ìƒì„± (auth-hpa, wallet-hpa)
- [ ] PDB 2ê°œ ìƒì„± (auth-pdb, wallet-pdb)

---

## ğŸ§ª ë°°í¬ ê²€ì¦ (í…ŒìŠ¤íŠ¸)

### Test 1: Pod ë‚´ë¶€ í…ŒìŠ¤íŠ¸
```bash
# Pod ì´ë¦„ í™•ì¸
$pods = kubectl get pods -n lionpay -l app=auth -o jsonpath='{.items[0].metadata.name}'

# Auth Podì—ì„œ ì§ì ‘ í…ŒìŠ¤íŠ¸
kubectl exec -it $pods -n lionpay -- curl http://localhost:8080/api/v1/auth/health

# Walletë„ ë™ì¼í•˜ê²Œ í…ŒìŠ¤íŠ¸
```
- [ ] Auth í—¬ìŠ¤ì²´í¬ ì„±ê³µ (200 OK)
- [ ] Wallet í—¬ìŠ¤ì²´í¬ ì„±ê³µ (200 OK)

### Test 2: ì„œë¹„ìŠ¤ ë‚´ë¶€ í†µì‹  í…ŒìŠ¤íŠ¸
```bash
# Auth Podì—ì„œ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
kubectl exec -it -n lionpay <AUTH_POD_NAME> -- \
  curl http://wallet-service:8081/api/v1/wallet/health
```
- [ ] ì„œë¹„ìŠ¤ ê°„ í†µì‹  ì„±ê³µ

### Test 3: ALB ê²½ìœ  í…ŒìŠ¤íŠ¸
```bash
# ALB DNS ì£¼ì†Œ í™•ì¸
$albDns = kubectl get ingress -n lionpay -o jsonpath='{.items[0].status.loadBalancer.ingress[0].hostname}'
Write-Host "ALB Address: $albDns"

# Host í—¤ë”ë¥¼ í¬í•¨í•œ ìš”ì²­
curl -H "Host: api.lionpay.shop" "http://$albDns/api/v1/auth/health"
curl -H "Host: api.lionpay.shop" "http://$albDns/api/v1/wallet/health"
```
- [ ] Auth ì—”ë“œí¬ì¸íŠ¸ ì‘ë‹µ ì„±ê³µ
- [ ] Wallet ì—”ë“œí¬ì¸íŠ¸ ì‘ë‹µ ì„±ê³µ

### Test 4: CORS í…ŒìŠ¤íŠ¸
```bash
# Preflight ìš”ì²­ í…ŒìŠ¤íŠ¸
curl -X OPTIONS "http://$albDns/api/v1/auth/health" \
  -H "Host: api.lionpay.shop" \
  -H "Origin: https://lionpay.shop" \
  -H "Access-Control-Request-Method: GET" \
  -v

# ì‘ë‹µ í—¤ë”ì— ë‹¤ìŒì´ í¬í•¨ë˜ì–´ì•¼ í•¨:
# Access-Control-Allow-Origin: https://lionpay.shop
# Access-Control-Allow-Methods: GET, POST, PUT, DELETE
```
- [ ] CORS í—¤ë” í¬í•¨ë¨
- [ ] Access-Control-Allow-Origin ì„¤ì •ë¨

### Test 5: ë¡œê·¸ í™•ì¸
```bash
# Auth ì„œë¹„ìŠ¤ ë¡œê·¸
kubectl logs -n lionpay -l app=auth --tail=50

# Wallet ì„œë¹„ìŠ¤ ë¡œê·¸
kubectl logs -n lionpay -l app=wallet --tail=50

# íŠ¹ì • Pod ë¡œê·¸
kubectl logs -n lionpay <POD_NAME>
```
- [ ] ì—ëŸ¬ ë©”ì‹œì§€ ì—†ìŒ
- [ ] ì •ìƒ ì‹œì‘ ë¡œê·¸ í™•ì¸ë¨

---

## ğŸ“Š ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

### HPA ìƒíƒœ í™•ì¸
```bash
kubectl describe hpa auth-hpa -n lionpay
kubectl describe hpa wallet-hpa -n lionpay
```

í™•ì¸ ì‚¬í•­:
- [ ] Current replicas: 2
- [ ] Desired replicas: 2
- [ ] Target CPU: 70%
- [ ] Metrics available

### ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ í™•ì¸
```bash
kubectl top nodes
kubectl top pods -n lionpay
```

- [ ] CPU ì‚¬ìš©ëŸ‰ ì •ìƒ ë²”ìœ„ ë‚´ (0-70%)
- [ ] ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì •ìƒ ë²”ìœ„ ë‚´ (0-80%)

---

## ğŸŒ CloudFront ì„¤ì • (ë³„ë„)

### ì‚¬ì „ í™•ì¸
- [ ] Route53ì—ì„œ ë„ë©”ì¸ ì†Œìœ  í™•ì¸
- [ ] ACMì—ì„œ SSL ì¸ì¦ì„œ ë°œê¸‰ (us-east-1 ë¦¬ì „)
  - ì¸ì¦ì„œ ë„ë©”ì¸: api.lionpay.shop

### CloudFront Distribution ìƒì„±
- [ ] Distribution Name: api.lionpay.shop
- [ ] Origin Domain: (ìœ„ì—ì„œ í™•ì¸í•œ ALB DNS)
- [ ] Origin Protocol: HTTP Only
- [ ] Alternate Domain Names (CNAMEs): api.lionpay.shop
- [ ] Custom SSL Certificate: (ìœ„ì—ì„œ ë°œê¸‰í•œ ì¸ì¦ì„œ)
- [ ] Viewer Protocol Policy: Redirect HTTP to HTTPS
- [ ] Allowed Methods: GET, HEAD, OPTIONS, PUT, POST, PATCH, DELETE
- [ ] Cache Policy: CachingDisabled (APIì´ë¯€ë¡œ)

### Route53 CNAME ì„¤ì •
- [ ] í˜¸ìŠ¤íŠ¸ ì´ë¦„: api.lionpay.shop
- [ ] íƒ€ì…: CNAME
- [ ] ê°’: (CloudFront Distribution ë„ë©”ì¸)

---

## ğŸ”„ ì´í›„ ë°°í¬ ë° ì—…ë°ì´íŠ¸

### Dev í™˜ê²½ ë°°í¬ ìë™í™”
```bash
# í™˜ê²½ë³€ìˆ˜ ì •ì˜
$env:ENV = "dev"
$env:IMAGE_TAG = "latest"

# ë°°í¬
kubectl apply -k kubernetes/overlays/dev
```
- [ ] ìŠ¤í¬ë¦½íŠ¸í™” ì™„ë£Œ

### Prod í™˜ê²½ ë°°í¬
```bash
# Prod ë°°í¬ ì „ í™•ì¸
kubectl kustomize kubernetes/overlays/prod | head -100

# Prod ë°°í¬
kubectl apply -k kubernetes/overlays/prod
```
- [ ] Prod ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ê²€ì¦ ì™„ë£Œ
- [ ] Prod ë°°í¬ í…ŒìŠ¤íŠ¸ ì™„ë£Œ

### ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ë°©ë²•
```bash
# ìƒˆ ì´ë¯¸ì§€ë¡œ ë°°í¬
kubectl set image deployment/auth-deployment \
  auth=<AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-2.amazonaws.com/lionpay-auth:v1.1 \
  -n lionpay

# ë°°í¬ ìƒíƒœ í™•ì¸
kubectl rollout status deployment/auth-deployment -n lionpay
```
- [ ] ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ í”„ë¡œì„¸ìŠ¤ ì´í•´
- [ ] ë¡¤ë°± ë°©ë²• ì´í•´

---

## âŒ ë¬¸ì œ í•´ê²°

### ë¬¸ì œ: Podì´ Pending ìƒíƒœ
```bash
kubectl describe pod <POD_NAME> -n lionpay
# Events ì„¹ì…˜ì—ì„œ ì´ìœ  í™•ì¸
```
- [ ] ì›ì¸ íŒŒì•… ë° í•´ê²°

### ë¬¸ì œ: ImagePullBackOff
```bash
# ECR ì´ë¯¸ì§€ í™•ì¸
aws ecr describe-images --repository-name lionpay-auth --region ap-northeast-2

# ECR ì¸ì¦ í† í° ê°±ì‹ 
aws ecr get-login-password --region ap-northeast-2 | \
  docker login --username AWS --password-stdin <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-2.amazonaws.com
```
- [ ] ECR ì´ë¯¸ì§€ í™•ì¸ ë° ì¬í‘¸ì‹œ

### ë¬¸ì œ: Ingressê°€ ALB ìƒì„± ì•ˆ í•¨
```bash
# ALB Ingress Controller ë¡œê·¸ í™•ì¸
kubectl logs -n kube-system -l app.kubernetes.io/name=aws-load-balancer-controller -f

# IAM ì—­í•  ê¶Œí•œ í™•ì¸
aws iam list-attached-role-policies --role-name eks-nodegroup-role
```
- [ ] ê¶Œí•œ ì„¤ì • í™•ì¸ ë° ìˆ˜ì •

### ë¬¸ì œ: CORS ì˜¤ë¥˜
```bash
# 1. ìš”ì²­ í—¤ë” í™•ì¸
curl -v https://api.lionpay.shop/api/v1/auth/health

# 2. ë°±ì—”ë“œ ì„¤ì • í™•ì¸
# SecurityConfig.java ë˜ëŠ” Program.csì˜ CORS ì„¤ì • í™•ì¸

# 3. Origin í™•ì¸
# ìš”ì²­í•˜ëŠ” ë„ë©”ì¸ì´ í—ˆìš© ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸
```
- [ ] CORS ì„¤ì • ê²€ì¦ ë° ìˆ˜ì •

---

## ğŸ“ˆ ë‹¤ìŒ ë‹¨ê³„ (ë°°í¬ í›„)

### Monitoring & Logging
- [ ] CloudWatch Logs í†µí•©
- [ ] Prometheus + Grafana ì„¤ì •
- [ ] ì•ŒëŒ ê·œì¹™ ì„¤ì •

### Security
- [ ] Network Policy ì„¤ì •
- [ ] Pod Security Policy ì ìš©
- [ ] Secret ê´€ë¦¬ (ë¯¼ê°í•œ ì •ë³´)

### Optimization
- [ ] ë¦¬ì†ŒìŠ¤ ìš”ì²­/ì œí•œ ìµœì í™”
- [ ] HPA ê¸°ì¤€ê°’ ì¡°ì •
- [ ] ìºì‹± ì „ëµ ìˆ˜ë¦½

### CI/CD
- [ ] GitOps íŒŒì´í”„ë¼ì¸ ì„¤ì • (ArgoCD ë“±)
- [ ] ìë™ ë°°í¬ ì„¤ì •
- [ ] ë°°í¬ ì „ í…ŒìŠ¤íŠ¸ ìë™í™”

---

## ğŸ“ ìµœì¢… í™•ì¸ (ë°°í¬ ì™„ë£Œ)

ì™„ë£Œ ì‹œì ì— ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

```bash
# 1. ëª¨ë“  Pod ì‹¤í–‰ ì¤‘
kubectl get pods -n lionpay
# READY: ëª¨ë‘ 1/1

# 2. ëª¨ë“  ì„œë¹„ìŠ¤ ìƒì„±ë¨
kubectl get svc -n lionpay
# auth-service, wallet-service

# 3. ALB Ingress ìƒì„±ë¨
kubectl get ingress -n lionpay
# ìƒíƒœ: ADDRESS í•„ë“œì— ELB DNS

# 4. HPA ì •ìƒ ì‘ë™
kubectl get hpa -n lionpay
# TARGETS: ì •ìƒ ë²”ìœ„

# 5. ë¡œê·¸ í™•ì¸
kubectl logs -n lionpay -l app=auth --tail=20
kubectl logs -n lionpay -l app=wallet --tail=20
# ì—ëŸ¬ ì—†ìŒ
```

ëª¨ë“  í•­ëª© í™•ì¸ í›„:
- [ ] **ë°°í¬ ì„±ê³µ!** ğŸ‰

---

## ğŸ“ ê¸°ë¡

| í•­ëª© | ë‚ ì§œ | ìƒíƒœ |
|------|------|------|
| ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„± | 2025-12-30 | âœ… |
| CORS ì„¤ì • | - | â³ |
| ì´ë¯¸ì§€ ë¹Œë“œ | - | â³ |
| Dev ë°°í¬ | - | â³ |
| ë°°í¬ ê²€ì¦ | - | â³ |
| CloudFront ì„¤ì • | - | â³ |
| Prod ë°°í¬ | - | â³ |

---

**ì´ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ì™„ë£Œí•˜ë©´ LionPay ì¿ ë²„ë„¤í‹°ìŠ¤ ë°°í¬ê°€ ì™„ì„±ë©ë‹ˆë‹¤!** ğŸš€
